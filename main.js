(()=>{var n=Tiles={BLUE:0,CYAN:1,ORANGE:2,YELLOW:3,GREEN:4,RED:5,PURPLE:6,BOARD:7,BORDER_BOTTOM:8,BORDER_LEFT:9,BORDER_TOP:10,BORDER_RIGHT:11,GHOST:12,HELPER:13,EMPTY:14,EMPTY2:15,BORDER_CORNER_BOTTOM_LEFT:16,BORDER_CORNER_TOP_LEFT:17,BORDER_CORNER_TOP_RIGHT:18,BORDER_CORNER_BOTTOM_RIGHT:19};cos=Math.cos(Math.PI/2);sin=Math.sin(Math.PI/2);RotationMatrix=[cos,sin,-sin,cos];var u={L:"L",I:"I",J:"J",O:"O",S:"S",T:"T",Z:"Z"},S=()=>{let l=Object.values(u);return chosen=l[Math.floor(Math.random()*l.length)],chosen},v={L:n.ORANGE,I:n.CYAN,J:n.BLUE,O:n.YELLOW,S:n.GREEN,T:n.PURPLE,Z:n.RED},d={I:[[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]],JLOSTZ:[[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]]]};var x={I:[0,0],O:[0,0],J:[-.5,.5],L:[-.5,.5],S:[-.5,.5],T:[-.5,.5],Z:[-.5,.5]},w={L:{cells:[[1,1],[-1,0],[0,0],[1,0]],wallKicks:d.JLOSTZ},I:{cells:[[-1,1],[0,1],[1,1],[2,1]],wallKicks:d.I},J:{cells:[[-1,1],[-1,0],[0,0],[1,0]],wallKicks:d.JLOSTZ},O:{cells:[[0,0],[1,0],[0,1],[1,1]],wallKicks:d.JLOSTZ},S:{cells:[[-1,0],[0,0],[0,1],[1,1]],wallKicks:d.JLOSTZ},T:{cells:[[-1,0],[0,0],[1,0],[0,1]],wallKicks:d.JLOSTZ},Z:{cells:[[-1,1],[0,1],[0,0],[1,0]],wallKicks:d.JLOSTZ}};function E(l,e,s,t){type=S();let c=w[type],a=l.add.container(e,s).setScale(t);return a.setData("cells",c.cells),a.setData("wallKicks",c.wallKicks),a.setData("tile",v[type]),a.setData("type",type),a.setData("rotationIndex",0),a.setData("rotation",[0,0]),a.setData("x",e),a.setData("y",s),a}function I(l,e,s){return l<e?s-(e-l)%(s-e):e+(l-e)%(s-e)}function P(l,e,s,t,c){originalRotation=t.getData("rotationIndex")||0,rotationIndex=I(originalRotation+c,0,4),R(t,c),k(l,e,s,t,rotationIndex,c)||(rotationIndex=originalRotation,R(t,-c))}function k(l,e,s,t,c,a){for(wallKicks=t.getData("wallKicks"),wallKickIndex=L(c,a),i=0;i<5;i++)if(translation=wallKicks[wallKickIndex][i],p(l,e,s,t,translation,!0))return!0;return!1}function L(l,e){return wallKickIndex=l*2,e<0&&wallKickIndex--,I(wallKickIndex,0,8)}function B(l,e,s,t,c,a){let h=t.getData("cells"),T=t.getData("type"),o=t.getData("x"),g=t.getData("y");l.clear();for(let r=0;r<h.length;r++){let f=o+h[r][0]+c[0],O=g+h[r][1]-c[1];if(f<0||f>9||O<0||O>19)return!1;wx=e.tileToWorldX(f),wy=e.tileToWorldY(20-O),l.lineStyle(1,16776960),l.strokeRectShape(new Phaser.Geom.Rectangle(wx,wy,64*s,64*s));let y=e.getTileAt(f,20-O);if(!y||y.index!==n.BOARD)return!1}return!0}function p(l,e,s,t,c,a){return isValid=B(l,e,s,t,c,a),isValid&&(t.setData("x",t.getData("x")+c[0]),t.setData("y",t.getData("y")-c[1]),t.x=e.tileToWorldX(t.getData("x")),t.y=e.tileToWorldY(19-t.getData("y"))),isValid}function R(l,e){let s=x[l.getData("type")],t=l.getData("cells"),c=l.getData("type"),a=RotationMatrix,h=[],T=c===u.O||c===u.I;if(T)for(let o=0;o<t.length;o++)t[o][0]-=.5,t[o][1]-=.5;for(let o=0;o<t.length;o++){let g=parseFloat((t[o][0]*a[0]*e+t[o][1]*a[1]*e).toFixed(1)),r=parseFloat((t[o][0]*a[2]*e+t[o][1]*a[3]*e).toFixed(1));h.push([T?Math.ceil(g):Math.round(g),T?Math.ceil(r):Math.round(r)])}return l.setData("cells",h),tmp=[parseFloat((s[0]*a[0]*e+s[1]*a[1]*e).toFixed(1)),parseFloat((s[0]*a[2]*e+s[1]*a[3]*e).toFixed(1))],l.setData("rotation",tmp),h}WIDTH=768;HEIGHT=1024;BOARD_WIDTH=10;BOARD_HEIGHT=20;BLOCK_SIZE=64;var D=class extends Phaser.Scene{constructor(){super({key:"Jetris",active:!0}),this.container,this.level,this.center={x:WIDTH/2,y:HEIGHT/2},this.deltaX=this.center.x*2/8,this.deltaY=this.center.y*2/20,this.gameScale=this.deltaX*2.5/this.center.x,this.gameScaleY=this.deltaY*2.5/this.center.y,this.adjustedBlockSize=BLOCK_SIZE*this.gameScale,this.elapsed=0,this.activePiece,this.graphics}preload(){this.load.spritesheet("tetris","assets/Sprites/tetris.png",{frameWidth:BLOCK_SIZE,frameHeight:BLOCK_SIZE}),this.load.spritesheet("fullscreen","assets/ui/fullscreen.png",{frameWidth:BLOCK_SIZE,frameHeight:BLOCK_SIZE})}createTileMap(){this.level=Array.from({length:BOARD_HEIGHT},()=>Array.from({length:BOARD_WIDTH},()=>n.BOARD)),this.map=this.make.tilemap({data:this.level,tileWidth:BLOCK_SIZE,tileHeight:BLOCK_SIZE});let e=this.map.addTilesetImage("tetris"),s=this.map.createLayer(0,e,this.center.x-BOARD_WIDTH/2*BLOCK_SIZE*this.gameScale,BLOCK_SIZE*this.gameScale).setScale(this.gameScale)}setTile(e,s,t){this.map.putTileAt(t,e,BOARD_HEIGHT-s)}setTetromino(e){let s=e.getData("cells"),t=e.getData("x"),c=e.getData("y");for(let a=0;a<s.length;a++)for(let h=0;h<s[a].length-1;h++)this.setTile(t+s[a][h],c+s[a][h+1],e.getData("tile"))}clearTetromino(e){let s=e.getData("cells"),t=e.getData("x"),c=e.getData("y");for(let a=0;a<s.length;a++)for(let h=0;h<s[a].length-1;h++)this.setTile(t+s[a][h],c+s[a][h+1],7)}addFullScreenToggle(){let e=this.add.image(WIDTH-16,16,"fullscreen",0).setOrigin(1,0).setScale(.25).setInteractive();e.on("pointerup",function(){this.scale.isFullscreen?(e.setFrame(0),this.scale.stopFullscreen()):(e.setFrame(1),this.scale.startFullscreen())},this)}moveActivePiece(e){this.activePiece&&(this.clearTetromino(this.activePiece),p(this.graphics,this.map,this.gameScale,this.activePiece,e),this.setTetromino(this.activePiece))}rotateActivePiece(e){this.clearTetromino(this.activePiece),P(this.graphics,this.map,this.gameScale,this.activePiece,e),this.setTetromino(this.activePiece)}create(){this.createTileMap(),this.addFullScreenToggle(),this.spawn(),this.setTetromino(this.activePiece),this.input.addPointer(1),this.input.keyboard.on("keydown-LEFT",()=>{this.moveActivePiece([-1,0])}),this.input.keyboard.on("keydown-RIGHT",()=>{this.moveActivePiece([1,0])}),this.input.keyboard.on("keydown-DOWN",()=>{this.moveActivePiece([0,1])}),this.input.keyboard.on("keydown-E",()=>{this.rotateActivePiece(1)}),this.input.keyboard.on("keydown-Q",()=>{this.rotateActivePiece(-1)}),this.input.keyboard.on("keydown-SPACE",()=>{for(this.clearTetromino(this.activePiece);p(this.graphics,this.map,this.gameScale,this.activePiece,[0,1]););this.setTetromino(this.activePiece),this.spawn(),this.setTetromino(this.activePiece),this.elapsed=0}),this.input.keyboard.on("keydown-P",()=>{this.scene.isPaused()?this.scene.resume():this.scene.pause()}),this.input.keyboard.on("keydown-ESC",()=>{this.map.fill(n.BOARD),this.spawn()}),this.input.on("pointerdown",e=>{e.x<this.center.x?this.moveActivePiece([-1,0]):this.moveActivePiece([1,0])}),this.graphics=this.add.graphics()}spawn(){this.activePiece&&this.activePiece.destroy(),this.activePiece=E(this,4,18,this.gameScale)}update(e,s){this.elapsed+=s,this.elapsed>1e3&&(this.elapsed=0),this.elapsed===0&&this.activePiece&&(this.clearTetromino(this.activePiece),p(this.graphics,this.map,this.gameScale,this.activePiece,[0,1])||(this.setTetromino(this.activePiece),this.spawn()),this.setTetromino(this.activePiece))}},m={type:Phaser.WEBGL,scale:{mode:Phaser.Scale.FIT,parent:"jetris",autoCenter:Phaser.Scale.CENTER_BOTH,width:WIDTH,height:HEIGHT},width:WIDTH,height:HEIGHT,backgroundColor:"#2d2d2d",scene:[D]},M=new Phaser.Game(m);})();
