(()=>{var g=Tiles={BLUE:0,CYAN:1,ORANGE:2,YELLOW:3,GREEN:4,RED:5,PURPLE:6,BOARD:7,BORDER_BOTTOM:8,BORDER_LEFT:9,BORDER_TOP:10,BORDER_RIGHT:11,GHOST:12,HELPER:13,EMPTY:14,EMPTY2:15,BORDER_CORNER_BOTTOM_LEFT:16,BORDER_CORNER_TOP_LEFT:17,BORDER_CORNER_TOP_RIGHT:18,BORDER_CORNER_BOTTOM_RIGHT:19};cos=Math.cos(Math.PI/2);sin=Math.sin(Math.PI/2);RotationMatrix=[cos,sin,-sin,cos];TetrominoBag=[];var O={L:"L",I:"I",J:"J",O:"O",S:"S",T:"T",Z:"Z"},I=()=>{if(TetrominoBag.length===0){let e=Object.keys(O);for(let t=e.length-1;t>0;t--){let s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}TetrominoBag=[...e]}let c=TetrominoBag.pop();return DEBUG&&console.log("Tetromino bag: ",TetrominoBag),c},R={L:g.ORANGE,I:g.CYAN,J:g.BLUE,O:g.YELLOW,S:g.GREEN,T:g.PURPLE,Z:g.RED},D={I:[[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]],JLOSTZ:[[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]]]};var S={I:[0,0],O:[0,0],J:[-.5,.5],L:[-.5,.5],S:[-.5,.5],T:[-.5,.5],Z:[-.5,.5]},T={L:{cells:[[1,1],[-1,0],[0,0],[1,0]],wallKicks:D.JLOSTZ,color:16753920},I:{cells:[[-1,1],[0,1],[1,1],[2,1]],wallKicks:D.I,color:65535},J:{cells:[[-1,1],[-1,0],[0,0],[1,0]],wallKicks:D.JLOSTZ,color:255},O:{cells:[[0,0],[1,0],[0,1],[1,1]],wallKicks:D.JLOSTZ,color:16776960},S:{cells:[[-1,0],[0,0],[0,1],[1,1]],wallKicks:D.JLOSTZ,color:65280},T:{cells:[[-1,0],[0,0],[1,0],[0,1]],wallKicks:D.JLOSTZ,color:8388736},Z:{cells:[[-1,1],[0,1],[0,0],[1,0]],wallKicks:D.JLOSTZ,color:16711680}};function m(c){return JSON.parse(JSON.stringify(c))}function x(c,e,t,s){let o=I(),a=T[o],l=c.add.container(e,t-(o===T.I?1:0)).setScale(s);return l.setData("cells",m(a.cells)),l.setData("color",a.color),l.setData("wallKicks",a.wallKicks),l.setData("tile",R[o]),l.setData("type",o),l.setData("rotationIndex",0),l.setData("rotation",[0,0]),l.setData("x",e),l.setData("y",t-(o===T.I?1:0)),DEBUG&&console.log("Spawned tetromino: ",l),l}function P(c,e,t){let s=e.getData("type"),o=T[s],a=c.add.container(0,0).setScale(t);return a.setData("tile",g.GHOST),a.setData("cells",m(e.getData("cells"))),a.setData("type",e.getData("type")),a.setData("rotationIndex",e.getData("rotationIndex")),a.setData("rotation",e.getData("rotation")),a.setData("x",e.getData("x")),a.setData("y",e.getData("y")),a.setData("wallKicks",e.getData("wallKicks")),a}function B(c,e,t){return c<e?t-(e-c)%(t-e):e+(c-e)%(t-e)}function k(c,e,t,s,o){originalRotation=s.getData("rotationIndex")||0,rotationIndex=B(originalRotation+o,0,4),DEBUG&&console.log("Rotation: ",rotationIndex),E(s,o),v(c,e,t,s,rotationIndex,o)||(rotationIndex=originalRotation,E(s,-o)),s.setData("rotationIndex",rotationIndex)}function v(c,e,t,s,o,a){for(wallKicks=s.getData("wallKicks"),wallKickIndex=G(o,a),DEBUG&&console.log("Wall kicks being evaluated: ",wallKicks[wallKickIndex]),i=0;i<5;i++)if(translation=wallKicks[wallKickIndex][i],f(c,e,t,s,translation,!0))return DEBUG&&console.log("Wall kick success"),!0;return DEBUG&&console.log("Wall kick failure"),!1}function G(c,e){return wallKickIndex=c*2,e<0&&wallKickIndex--,B(wallKickIndex,0,8)}function L(c,e,t,s,o,a){let l=s.getData("cells"),n=s.getData("type"),d=s.getData("x"),r=s.getData("y");DEBUG&&(c.clear(),console.log("Testing move: ",o));for(let h=0;h<l.length;h++){let p=d+l[h][0]+o[0],u=r+l[h][1]-o[1];if(DEBUG&&(wx=e.tileToWorldX(p),wy=e.tileToWorldY(20-u),c.lineStyle(1,16711935),c.strokeRectShape(new Phaser.Geom.Rectangle(wx,wy,64*t,64*t))),p%1!=0||u%1!=0)return DEBUG&&console.log("Bug: ",p,u),!1;let y=e.getTileAt(p,20-u);if(!y||y.index!==g.BOARD&&y.index!==g.GHOST)return DEBUG&&console.log("Tile occupied"),!1}return!0}function f(c,e,t,s,o,a){return isValid=L(c,e,t,s,o,a),isValid&&(s.setData("x",s.getData("x")+o[0]),s.setData("y",s.getData("y")-o[1]),s.x=e.tileToWorldX(s.getData("x")),s.y=e.tileToWorldY(19-s.getData("y"))),isValid}function E(c,e){let t=S[c.getData("type")],s=c.getData("cells"),o=c.getData("type"),a=RotationMatrix,l=[],n=o===O.O||o===O.I;if(n)for(let d=0;d<s.length;d++)s[d][0]-=.5,s[d][1]-=.5;for(let d=0;d<s.length;d++){let r=parseFloat((s[d][0]*a[0]*e+s[d][1]*a[1]*e).toFixed(1)),h=parseFloat((s[d][0]*a[2]*e+s[d][1]*a[3]*e).toFixed(1));l.push([n?Math.ceil(r):Math.round(r),n?Math.ceil(h):Math.round(h)])}return c.setData("cells",l),tmp=[parseFloat((t[0]*a[0]*e+t[1]*a[1]*e).toFixed(1)),parseFloat((t[0]*a[2]*e+t[1]*a[3]*e).toFixed(1))],c.setData("rotation",tmp),l}WIDTH=640;HEIGHT=1024;DEBUG=!1;BOARD_WIDTH=10;BOARD_HEIGHT=20;BLOCK_SIZE=64;isClicking=!1;swipeDirection="";touchDeltaX=0;touchDeltaY=0;swipeDelay=0;dropped=!1;clicked=!1;dragged=!1;var w=class extends Phaser.Scene{constructor(){super({key:"Jetris",active:!0});this.container,this.level,this.center={x:WIDTH/2,y:HEIGHT/2},this.deltaX=this.center.x*2/8,this.deltaY=this.center.y*2/20,this.gameScale=this.deltaX*2.5/this.center.x,this.gameScaleY=this.deltaY*2.5/this.center.y,this.adjustedBlockSize=BLOCK_SIZE*this.gameScale,this.elapsed=0,this.activePiece,this.ghostPiece,this.graphics,this.gameOver=!1,this.layer,this.ghostLayer,this.rockLayer,this.waterLayer,this.rowClearParticles,this.particleEmitter}preload(){this.load.image("block",["assets/Sprites/tetris.png","assets/Sprites/tetris_n.png"]),this.load.spritesheet("fullscreen","assets/ui/fullscreen.png",{frameWidth:BLOCK_SIZE,frameHeight:BLOCK_SIZE}),this.load.atlas("flares","assets/particles/flares.png","assets/particles/flares.json"),this.load.image("trail","assets/particles/trail.png"),this.load.image("streak","assets/particles/streak.png"),this.load.image("star","assets/particles/star.png")}createTileMap(){this.lights.enable().setAmbientColor(14540253);let e=this.lights.addLight(WIDTH,-HEIGHT,HEIGHT*3,16777215,4);this.level=Array.from({length:BOARD_HEIGHT},()=>Array.from({length:BOARD_WIDTH},()=>g.BOARD)),this.map=this.make.tilemap({key:"map_tiles",data:this.level,tileWidth:BLOCK_SIZE,tileHeight:BLOCK_SIZE});let t=this.map.addTilesetImage("tiles","block",BLOCK_SIZE,BLOCK_SIZE,0,0,0);this.ghostLayer=this.map.createBlankLayer("GhostLayer",t,this.center.x-BOARD_WIDTH/2*BLOCK_SIZE*this.gameScale,BLOCK_SIZE*this.gameScale).setScale(this.gameScale),this.layer=this.map.createBlankLayer("GameLayer",t,this.center.x-BOARD_WIDTH/2*BLOCK_SIZE*this.gameScale,BLOCK_SIZE*this.gameScale).setScale(this.gameScale),this.layer.setPipeline("Light2D"),this.map.fill(g.BOARD)}checkFractions(e,t){return e%1!=0||t%1!=0?(DEBUG&&console.log("bug: ",e,t),!0):!1}setTile(e,t,s){this.checkFractions(e,t)||(this.map.putTileAt(s,e,BOARD_HEIGHT-t,!1,s===g.GHOST?"GhostLayer":"GameLayer"),s===g.BOARD&&this.map.removeTileAt(e,BOARD_HEIGHT-t,!0,!1,"GhostLayer"))}getTile(e,t){return this.checkFractions(e,t)?null:this.map.getTileAt(e,BOARD_HEIGHT-t,!1,this.layer)}setTetromino(e){let t=e.getData("cells"),s=e.getData("x"),o=e.getData("y");if(this.checkFractions(s,o)){DEBUG&&console.log("SetTetromino: ",e);return}for(let a=0;a<t.length;a++)for(let l=0;l<t[a].length-1;l++){if(this.checkFractions(t[a][l],t[a][l+1])){DEBUG&&console.log("Move Data!!",tetrommino);return}let n=this.getTile(s+t[a][l],o+t[a][l+1]);if(n&&n.index===g.BOARD)this.setTile(s+t[a][l],o+t[a][l+1],e.getData("tile"));else{this.gameOver=!0;return}}}clearTetromino(e){let t=e.getData("cells"),s=e.getData("x"),o=e.getData("y");if(!this.checkFractions(s,o))for(let a=0;a<t.length;a++)for(let l=0;l<t[a].length-1;l++){if(this.checkFractions(t[a][l],t[a][l+1]))return;this.setTile(s+t[a][l],o+t[a][l+1],g.BOARD)}}addFullScreenToggle(){let e=this.add.image(WIDTH-16,16,"fullscreen",0).setOrigin(1,0).setScale(.25).setInteractive();e.on("pointerup",function(){this.scale.isFullscreen?(e.setFrame(0),this.scale.stopFullscreen()):(e.setFrame(1),this.scale.startFullscreen())},this)}moveActivePiece(e){this.activePiece&&(this.clearTetromino(this.activePiece),f(this.graphics,this.map,this.gameScale,this.activePiece,e),this.updateGhost(),this.setTetromino(this.activePiece))}rotateActivePiece(e){this.clearTetromino(this.activePiece),k(this.graphics,this.map,this.gameScale,this.activePiece,e),this.updateGhost(),this.setTetromino(this.activePiece)}lockTetromino(e){let t=new Set,s=e.getData("cells"),o=e.getData("x"),a=e.getData("y");if(!this.checkFractions(o,a)){for(let l=0;l<s.length;l++)for(let n=0;n<s[l].length-1;n++){if(this.checkFractions(s[l][n],s[l][n+1]))return;t.add(a+s[l][n+1])}t=Array.from(t).sort((l,n)=>n-l);for(let l=0;l<t.length;l++){let n=t[l],d=!0;for(let r=0;r<BOARD_WIDTH;r++){let h=this.getTile(r,n);if(!h||h.index===g.BOARD){d=!1;break}}if(d){for(let r=0;r<BOARD_WIDTH;r++)this.setTile(r,n,g.BOARD);for(let r=n+1;r<BOARD_HEIGHT;r++)for(let h=0;h<BOARD_WIDTH;h++){let p=this.getTile(h,r);p&&p.index!==g.BOARD&&(this.setTile(h,r-1,p.index),this.setTile(h,r,g.BOARD))}this.showRowClearFX(n-1)}}}}getBoundingBox(e){let t=e.getData("cells"),s=e.getData("x"),o=e.getData("y");if(this.checkFractions(s,o))return;let a=BOARD_WIDTH,l=0,n=BOARD_HEIGHT,d=0;for(let r=0;r<t.length;r++)for(let h=0;h<t[r].length-1;h++){if(this.checkFractions(t[r][h],t[r][h+1]))return;a=Math.min(a,s+t[r][h]),l=Math.max(l,s+t[r][h]),n=Math.min(n,o+t[r][h+1]),d=Math.max(d,o+t[r][h+1])}return new Phaser.Geom.Rectangle(this.map.tileToWorldX(a),this.map.tileToWorldY(19-d)+BLOCK_SIZE*this.gameScale,this.map.tileToWorldX(l)-this.map.tileToWorldX(a)+BLOCK_SIZE*this.gameScale,this.map.tileToWorldY(19-n)-this.map.tileToWorldY(19-d)+BLOCK_SIZE*this.gameScale)}drawDropAnimation(){let e=this.getBoundingBox(this.activePiece),t=this.getBoundingBox(this.ghostPiece),s=this.add.image(e.centerX,e.centerY,"trail");s.setOrigin(.5,0),s.setTint(this.activePiece.getData("color")),s.displayWidth=e.width,s.displayHeight=t.y-e.y,s.depth=-1,this.tweens.add({targets:s,displayHeight:0,y:t.y,alpha:0,duration:200,ease:"Linear",onComplete:()=>{s.destroy()}});let o=this.add.particles(t.centerX,t.y,"star",{speed:{min:400,max:1e3},angle:{min:-105,max:-75},scale:{start:.1,end:0},alpha:{start:.4,end:0},quantity:5,lifespan:500,blendMode:"ADD",gravityY:100,on:!1,onComplete:()=>{o.destroy()}});o.explode(),this.graphics.lineStyle(4,65280,1),this.graphics.strokeRectShape(e),this.tweens.add({targets:this.graphics,alpha:0,duration:400,ease:"Linear",onComplete:()=>{this.graphics.clear(),this.graphics.alpha=1}}),this.cameras.main.shake(100,.0025-5e-4*(this.ghostPiece.getData("y")-this.activePiece.getData("y")))}drop(){if(!this.gameOver){for(this.drawDropAnimation(),this.clearTetromino(this.activePiece),this.clearTetromino(this.ghostPiece);f(this.graphics,this.map,this.gameScale,this.activePiece,[0,1]););this.setTetromino(this.activePiece),this.lockTetromino(this.activePiece),this.spawn(),this.setTetromino(this.activePiece),this.elapsed=0}}showRowClearFX(e){let t=this.add.particles(this.center.x*this.gameScale,0,"flares",{frame:{frames:["red","green","blue","white","yellow"],cycle:!0},blendMode:"ADD",lifespan:300,quantity:1,manualEmit:!0,frequency:7,alpha:{start:1,end:0},scale:{start:1,end:.1},onComplete:()=>{t.destroy()}});t.stop(),t.addEmitZone({type:"edge",source:new Phaser.Geom.Line(this.map.tileToWorldX(-4.5),this.map.tileToWorldY(19.5-e),this.map.tileToWorldX(5.5),this.map.tileToWorldY(19.5-e)),quantity:10,total:1}),t.start(50,50)}setupInput(){this.input.addPointer(1),this.input.keyboard.on("keydown-LEFT",()=>{this.moveActivePiece([-1,0])}),this.input.keyboard.on("keydown-RIGHT",()=>{this.moveActivePiece([1,0])}),this.input.keyboard.on("keydown-DOWN",()=>{this.moveActivePiece([0,1])}),DEBUG&&this.input.keyboard.on("keydown-UP",()=>{this.moveActivePiece([0,-1])}),this.input.keyboard.on("keydown-E",()=>{this.rotateActivePiece(1)}),this.input.keyboard.on("keydown-Q",()=>{this.rotateActivePiece(-1)}),this.input.keyboard.on("keydown-SPACE",()=>{this.drop()}),this.input.keyboard.on("keydown-P",()=>{this.scene.isPaused()?this.scene.resume():this.scene.pause()}),this.input.keyboard.on("keydown-ESC",()=>{this.map.fill(g.BOARD),this.map.fill(null,0,0,BOARD_WIDTH,BOARD_HEIGHT,!0,"GhostLayer"),this.gameOver=!1,this.spawn(),this.setTetromino(this.activePiece)})}create(){this.createTileMap(),this.addFullScreenToggle(),this.spawn(),this.setupInput(),this.graphics=this.add.graphics(),this.setTetromino(this.activePiece),console.log(window.innerWidth,window.innerHeight,window.devicePixelRatio)}spawn(){for(this.activePiece&&this.activePiece.destroy(),this.ghostPiece&&this.ghostPiece.destroy(),this.activePiece=x(this,4,19,this.gameScale),this.ghostPiece=P(this,this.activePiece,this.gameScale);f(this.graphics,this.map,this.gameScale,this.ghostPiece,[0,1]););this.setTetromino(this.ghostPiece)}updateGhost(){for(this.clearTetromino(this.ghostPiece),this.ghostPiece.setData("x",this.activePiece.getData("x")),this.ghostPiece.setData("y",this.activePiece.getData("y")),this.ghostPiece.x=this.map.tileToWorldX(this.activePiece.getData("x")),this.ghostPiece.y=this.map.tileToWorldY(19-this.activePiece.getData("y")),this.ghostPiece.setData("cells",m(this.activePiece.getData("cells"))),this.ghostPiece.setData("rotationIndex",this.activePiece.getData("rotationIndex"));f(this.graphics,this.map,this.gameScale,this.ghostPiece,[0,1]););this.setTetromino(this.ghostPiece)}processTouch(){this.input.activePointer.isDown?(clicked=!0,Math.abs(this.input.activePointer.x-touchDeltaX)>=100?(this.input.activePointer.x<touchDeltaX?swipeDirection="left":this.input.activePointer.x>touchDeltaX&&touchDeltaX!=0?swipeDirection="right":(swipeDirection="",touchDeltaX=0),touchDeltaX=this.input.activePointer.x,swipeDirection!=""&&(this.moveActivePiece([swipeDirection=="left"?-1:1,0]),dragged=!0)):!dropped&&Math.abs(this.input.activePointer.y-touchDeltaY)>=200&&(this.input.activePointer.y>touchDeltaY&&touchDeltaY!=0?swipeDirection="down":(swipeDirection="",touchDeltaY=0),touchDeltaY=this.input.activePointer.y,swipeDirection=="down"&&(this.drop(),dropped=!0))):(touchDeltaX=0,touchDeltaY=0,clicked&&!dragged&&!dropped&&(this.input.activePointer.x<this.center.x?this.rotateActivePiece(-1):this.rotateActivePiece(1)),clicked=!1,dropped=!1,dragged=!1)}update(e,t){this.gameOver||(this.processTouch(),this.elapsed+=t,this.elapsed>1e3&&(this.elapsed=0),this.elapsed===0&&this.activePiece&&!DEBUG&&(this.clearTetromino(this.activePiece),f(this.graphics,this.map,this.gameScale,this.activePiece,[0,1])||(this.setTetromino(this.activePiece),this.lockTetromino(this.activePiece),this.spawn()),this.setTetromino(this.activePiece)))}},A={type:Phaser.WEBGL,scale:{mode:Phaser.Scale.FIT,parent:"jetris",autoCenter:Phaser.Scale.CENTER_BOTH,width:WIDTH,height:HEIGHT},width:WIDTH,height:HEIGHT,backgroundColor:"#2d2d2d",scene:[w]},C=new Phaser.Game(A);})();
